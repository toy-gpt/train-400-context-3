# ============================================================
# .github/workflows/links.yml (Lychee Link Checker)
# ============================================================
# SOURCE: https://github.com/denisecase/templates
#
# WHY-FILE: Automated link checking.
# OBS: Behavior is configured in lychee.toml in this repository.
# OBS: Runs on pull requests and monthly on schedule; manual trigger always available.
# OBS: This workflow always publishes a report table to the job summary.
# OBS: This workflow marks the run as failed (not green) when broken links are found.

name: Check Links

on:
  workflow_dispatch: # WHY: Manual trigger - always available
  pull_request: # WHY: Validates PR links before merge
  schedule:
    - cron: "0 6 1 * *" # WHY: Runs monthly (1st of month)

concurrency:
  # WHY: Prevent multiple simultaneous link checks on same ref
  group: link-check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lychee:
    name: Link checks
    runs-on: ubuntu-latest # WHY: Stable runner for lychee-action + bash steps.
    timeout-minutes: 20 # WHY: Prevent hanging jobs.

    permissions:
      contents: read # WHY: Needed to checkout code.
      issues: write # WHY: Needed to create issue on scheduled failures.
      pull-requests: write # WHY: Needed to comment on PR if links broken.

    steps:
      - name: 1) Checkout repository code
        uses: actions/checkout@v6 # OBS: Keep current major.

      - name: 2) Initialize report file (placeholder)
        # WHY: Ensure the job summary always has a table, even if Lychee crashes early.
        run: |
          cat > ./lychee-report.md << 'EOF'
          ## Lychee report
          No report yet (workflow still running).
          EOF

      - name: 3) Check links with Lychee
        id: lychee
        # WHY: Keep running summary/comment/issue steps even if Lychee finds failures.
        continue-on-error: true
        uses: lycheeverse/lychee-action@v2.7.0
        with:
          # WHY: Do not hard-fail inside the action; decide final status in the gate step.
          fail: false
          # WHY: Write a markdown report that we can publish into the job summary.
          output: ./lychee-report.md
          args: >
            --config lychee.toml
            --user-agent "${{ github.repository }}/lychee"
            './**/*.bib'
            './**/*.md'
            './**/*.html'
            './**/*.tex'
            './**/*.yml'
            './**/*.yaml'
          # OBS: Always use latest Lychee release.
          lycheeVersion: latest
        env:
          # WHY: Allows Lychee to authenticate to GitHub when checking links.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 4) Add results to job summary
        # WHY: Always show results table, even on success or when Lychee had issues.
        if: always()
        run: |
          echo "## Link Check Report" >> "$GITHUB_STEP_SUMMARY"
          if [ -f ./lychee-report.md ]; then
            cat ./lychee-report.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No report generated (lychee-report.md missing)." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Lychee exit code: ${{ steps.lychee.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"

      - name: 5) Comment on PR if links broken
        # WHY: Provide visibility directly on PRs when broken links are detected.
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require("fs");

            const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            const exitCode = `${{ steps.lychee.outputs.exit_code }}`; // may be empty
            const report = fs.readFileSync("./lychee-report.md", "utf8");

            // WHY: Decide broken-ness from exit code when present; fall back to report text.
            const looksBroken =
              (exitCode && exitCode !== "0") || /ERROR|FAIL|Dead link/i.test(report);

            if (!looksBroken) return;

            const body = [
              "## Link Check Results",
              "",
              "Broken links were detected (or the checker did not complete cleanly).",
              "",
              `Workflow run: ${runUrl}`,
              "",
              "Report:",
              "```",
              report.slice(0, 65000),
              "```",
            ].join("\n");

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });

      - name: 6) Create issue for scheduled failures
        # WHY: Track broken links found during scheduled checks.
        # OBS: Only creates issue if none already open with 'broken-links' label.
        if: always() && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require("fs");

            const exitCode = `${{ steps.lychee.outputs.exit_code }}`; // may be empty
            const report = fs.readFileSync("./lychee-report.md", "utf8");

            const looksBroken =
              (exitCode && exitCode !== "0") || /ERROR|FAIL|Dead link/i.test(report);

            if (!looksBroken) return;

            const date = new Date().toISOString().split("T")[0];
            const title = `Link Check Failed - ${date}`;
            const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            const body = [
              "Monthly link check found broken links (or the checker did not complete cleanly).",
              "",
              `Workflow run: ${runUrl}`,
              "",
              "Report:",
              "```",
              report.slice(0, 65000),
              "```",
            ].join("\n");

            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: "broken-links",
              state: "open",
              per_page: 1,
            });

            if (existing.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ["maintenance", "broken-links"],
              });
            }

      - name: 7) Gate fail job if broken links found
        # WHY: Ensure the overall status is not green when broken links are detected.
        if: always()
        run: |
          code="${{ steps.lychee.outputs.exit_code }}"

          if [ -z "$code" ]; then
            echo "::error::Lychee exit code missing (treating as failure so status is not green)."
            exit 1
          fi

          if [ "$code" != "0" ]; then
            echo "::error::Broken links detected (lychee exit code $code). See the job summary report."
            exit 1
          fi
